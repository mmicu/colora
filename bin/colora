#!/usr/bin/env node

'use strict';

const fs = require('fs');
const hljs = require('highlight.js');
const parserlib = require('parserlib');
const path = require('path');
const util = require('util');

function getThemesList(themesPath) {
  if (!fs.existsSync(themesPath)) return null;
  
  var themesPaths = {};
  fs.readdirSync(themesPath).forEach(file => {
    if (path.extname(file) == '.css')
      themesPaths[path.parse(file).name] = path.join(themesPath, file);
  });
  
  return themesPaths;
}

process.stdin.resume();
process.stdin.setEncoding('utf8');
process.stdin.on('data', function(data) {
  if (process.argv.length !== 3) {
    console.error(util.format('Usage: node %s <styles directory>', process.argv[1]));
    process.exit(1);
  }
  
  var themesPaths = getThemesList(process.argv[2]);
  
  if (themesPaths === null) {
    console.error(util.format('Cannot find styles in ("%s")', process.argv[2]));
  } else {
    var cssContent = fs.readFileSync(themesPaths[process.argv[2]], 'utf8');
    var res = process.argv.length > 3 
      ? hljs.highlight(process.argv[3], data) 
      : hljs.highlightAuto(data);
    var output = htmlout.withCSS(cssContent);

    console.log(output('<pre class="hljs">' + res.value + '</pre>'));
  }
});
